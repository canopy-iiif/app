"use strict";var B=Object.defineProperty;var nt=Object.getOwnPropertyDescriptor;var it=Object.getOwnPropertyNames;var rt=Object.prototype.hasOwnProperty;var at=(e,t,n)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var st=(e,t)=>{for(var n in t)B(e,n,{get:t[n],enumerable:!0})},ot=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of it(t))!rt.call(e,r)&&r!==n&&B(e,r,{get:()=>t[r],enumerable:!(i=nt(t,r))||i.enumerable});return e};var lt=e=>ot(B({},"__esModule",{value:!0}),e);var A=(e,t,n)=>(at(e,typeof t!="symbol"?t+"":t,n),n);var Fn={};st(Fn,{EMPTY:()=>s,HAS_PART:()=>u,IS_EXTERNAL:()=>S,PART_OF:()=>R,Traverse:()=>q,UNSET:()=>y,UNWRAP:()=>G,WILDCARD:()=>N,addFlagForExternalResource:()=>Q,compressSpecificResource:()=>_,defaultEntities:()=>hn,emptyAgent:()=>ae,emptyAnnotation:()=>ct,emptyAnnotationPage:()=>ee,emptyCanvas:()=>te,emptyCollection:()=>ne,emptyManifest:()=>ie,emptyRange:()=>re,emptyService:()=>se,frameResource:()=>ye,getDefaultEntities:()=>He,identifyResource:()=>he,isSpecificResource:()=>h,isWildcard:()=>ve,languageString2to3:()=>z,merge:()=>X,mergeEntities:()=>Y,normalize:()=>_n,resolveIfExists:()=>H,serialize:()=>xn,serializeConfigPresentation2:()=>Nn,serializeConfigPresentation3:()=>On,serializedFieldsToObject:()=>Xe,toRef:()=>$,traverseSpecificResource:()=>Qe,types:()=>oe});module.exports=lt(Fn);function h(e){return typeof e=="string"?!1:e&&!e.type&&"source"in e?(e.type="SpecificResource",!0):!!e&&e.type==="SpecificResource"}function $(e,t){let n=t||"unknown";if(!e)return;if(typeof e=="string")return{id:e,type:n};if(h(e))return $(e.source,t);let i=n&&n!=="unknown"?n:e.type||e["@type"],r=e.id||e["@id"];if(i&&i.indexOf(":")!==-1&&(i=i.split(":").pop()),r&&i)return{id:r,type:i}}var N={},u="iiif-parser:hasPart",R="iiif-parser:partOf",S="iiif-parser:isExternal",y="__$UNSET$__",G="__$UNWRAP$__",s=[];Object.freeze(s);Object.freeze(N);function ve(e){if(e===N||Object.keys(e).length===0)return!0;for(let t in e)return!1;return!0}function ye(e,t){if(t&&t["@explicit"]){let n={},i=Object.keys(t);for(let r of i)r===R||r==="@explicit"||(ve(t[r])?n[r]=e[r]:n[r]=t[r]);return n}return e}function H(e,t,n){let i=$(t);if(!i)return[void 0,void 0];let r=e.requests[i.id],a=i.type||e.mapping[i.id];if(!a||r&&r.resourceUri&&(!e.entities[a]||!e.entities[a][r.resourceUri]))return[void 0,void 0];let o=e.entities[a][r?r.resourceUri:i.id];if(i.type&&!o)return H(e,{id:i.id},n);if(o&&o[u]){let l=o[u].find(c=>n?c[R]===n.id:c[R]===o.id);return[ye(o,l),o]}return[o,o]}var ct={id:"https://iiif-parser/annotation",type:"Annotation",behavior:s,label:null,thumbnail:s,summary:null,requiredStatement:null,metadata:s,seeAlso:s,homepage:s,rendering:s,service:s,accessibility:s,audience:s,body:s,bodyValue:null,canonical:null,created:null,creator:s,generated:null,generator:s,modified:null,motivation:s,rights:null,stylesheet:null,target:s,timeMode:void 0,via:s,partOf:s},ee={id:"https://iiif-parser/annotation-page",type:"AnnotationPage",behavior:s,label:null,thumbnail:s,summary:null,requiredStatement:null,metadata:s,rights:null,provider:s,items:s,seeAlso:s,homepage:s,rendering:s,service:s},te={id:"https://iiif-parser/empty-canvas",type:"Canvas",label:null,behavior:s,thumbnail:s,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:s,rights:null,navDate:null,provider:s,items:s,annotations:s,seeAlso:s,homepage:s,partOf:s,rendering:s,service:s,duration:0,height:0,width:0},ne={id:"https://iiif-parser/empty-collection",type:"Collection",label:null,viewingDirection:"left-to-right",behavior:s,thumbnail:s,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:s,rights:null,navDate:null,provider:s,items:s,annotations:s,seeAlso:s,homepage:s,partOf:s,rendering:s,service:s,services:s},ie={id:"https://iiif-parser/empty-manifest",type:"Manifest",annotations:s,behavior:s,homepage:s,items:s,label:null,metadata:s,navDate:null,provider:s,partOf:s,accompanyingCanvas:null,placeholderCanvas:null,rendering:s,requiredStatement:null,rights:null,seeAlso:s,service:s,services:s,start:null,structures:s,summary:null,thumbnail:s,viewingDirection:"left-to-right"},re={id:"https://iiif-parser/empty-canvas",type:"Range",label:null,behavior:s,thumbnail:s,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:s,rights:null,navDate:null,provider:s,items:s,annotations:s,seeAlso:s,homepage:s,partOf:s,rendering:s,service:s,start:null,supplementary:null,viewingDirection:"left-to-right"},ae={id:"https://iiif-parser/empty-agent",type:"Agent",label:{},logo:s,seeAlso:s,homepage:s},se={id:"https://iiif-parser/empty-service",type:"UnknownService"};function m(e){return Array.isArray(e)?e:e?[e]:[]}function U(...e){return t=>e.reduce((n,i)=>i(n),t)}var oe=["Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent"];function he(e,t){if(typeof e>"u"||e===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(e))throw new Error("Array is not a valid entity");if(typeof e!="object"){if(t)return t;throw new Error(`${typeof e} is not a valid entity`)}if(typeof e.type=="string"){let n=oe.indexOf(e.type);if(n!==-1)return oe[n]}if(e.profile)return"Service";throw new Error("Resource type is not known")}var q=class e{constructor(t,n={}){A(this,"traversals");A(this,"options");A(this,"_traverseManifest",U(this.traverseManifestItems.bind(this),this.traverseNavPlace.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseManifestStructures.bind(this),this.traverseInlineAnnotationPages.bind(this)));A(this,"_traverseCanvas",U(this.traverseCanvasItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseInlineAnnotationPages.bind(this)));A(this,"_traverseAnnotationPage",U(this.traverseAnnotationPageItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this)));A(this,"_traverseRange",U(this.traverseRangeRanges.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this)));this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],specificResource:[],geoJson:[],...t},this.options={allowUndefinedReturn:!1,...n}}static all(t){return new e({collection:[t],manifest:[t],canvas:[t],annotationCollection:[t],annotationPage:[t],annotation:[t],contentResource:[t],choice:[t],range:[t],service:[t],geoJson:[t],specificResource:[t],agent:[t]})}traverseDescriptive(t){return t.thumbnail&&(t.thumbnail=m(t.thumbnail).map(n=>this.traverseType(n,{parent:t},this.traversals.contentResource))),t.provider&&(t.provider=t.provider.map(n=>this.traverseAgent(n,t))),t}traverseLinking(t){return t.seeAlso&&(t.seeAlso=m(t.seeAlso).map(n=>this.traverseType(n,{parent:t},this.traversals.contentResource))),t.service&&(t.service=m(t.service).map(n=>this.traverseService(n))),t.services&&(t.services=m(t.services).map(n=>this.traverseService(n,t))),t.logo&&(t.logo=m(t.logo).map(n=>this.traverseType(n,{parent:t},this.traversals.contentResource))),t.homepage&&(t.homepage=m(t.homepage).map(n=>this.traverseType(n,{parent:t},this.traversals.contentResource))),t.partOf&&(t.partOf=t.partOf.map(n=>typeof n=="string"||!n.type?this.traverseType(n,{parent:t},this.traversals.contentResource):n.type==="Canvas"?this.traverseType(n,{parent:t},this.traversals.canvas):n.type==="AnnotationCollection"?this.traverseType(n,{parent:t},this.traversals.annotationCollection):n.type==="Collection"?this.traverseType(n,{parent:t},this.traversals.collection):this.traverseType(n,{parent:t},this.traversals.contentResource))),t.start&&(h(t.start)?t.start=this.traverseSpecificResource(t.start,"Canvas",t):t.start=this.traverseType(t.start,{parent:t},this.traversals.canvas)),t.rendering&&(t.rendering=t.rendering.map(n=>this.traverseType(n,{parent:t},this.traversals.contentResource))),t.supplementary&&(t.supplementary=t.supplementary.map(n=>this.traverseType(n,{parent:t},this.traversals.contentResource))),t}traverseCollectionItems(t){return t.items&&t.items.map(n=>n.type==="Collection"?this.traverseCollection(n):this.traverseManifest(n)),t}traverseCollection(t,n){return this.traverseType(this.traverseDescriptive(this.traverseNavPlace(this.traverseInlineAnnotationPages(this.traverseLinking(this.traverseLinkedCanvases(this.traverseCollectionItems(t)))))),{parent:n},this.traversals.collection)}traverseGeoJson(t,n){return this.traverseType(t,{parent:n},this.traversals.geoJson)}traverseNavPlace(t){return t.navPlace&&(t.navPlace=this.traverseGeoJson(t.navPlace,t)),t}traverseManifestItems(t){return t.items&&(t.items=t.items.map(n=>this.traverseCanvas(n))),t}traverseManifestStructures(t){return t.structures&&(t.structures=t.structures.map(n=>this.traverseRange(n))),t}traverseManifest(t,n){return this.traverseType(this._traverseManifest(t),{parent:n},this.traversals.manifest)}traverseCanvasItems(t){return t.items=(t.items||[]).map(n=>this.traverseAnnotationPage(n,t)),t}traverseInlineAnnotationPages(t){return typeof t=="string"||!t||t.annotations&&(t.annotations=t.annotations.map(n=>this.traverseAnnotationPage(n,t))),t}traverseCanvas(t,n){return this.traverseType(this._traverseCanvas(t),{parent:n},this.traversals.canvas)}traverseAnnotationPageItems(t){return t.items&&(t.items=t.items.map(n=>this.traverseAnnotation(n,t))),t}traverseAnnotationPage(t,n){return this.traverseType(this._traverseAnnotationPage(t),{parent:n},this.traversals.annotationPage)}traverseAnnotationBody(t){return Array.isArray(t.body)?t.body=t.body.map(n=>this.traverseContentResource(n,t)):t.body&&(t.body=this.traverseContentResource(t.body,t)),t}traverseLinkedCanvases(t){return t.placeholderCanvas&&(t.placeholderCanvas=this.traverseCanvas(t.placeholderCanvas)),t.accompanyingCanvas&&(t.accompanyingCanvas=this.traverseCanvas(t.accompanyingCanvas)),t}traverseAnnotation(t,n){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(this.traverseDescriptive(t))),{parent:n},this.traversals.annotation)}traverseContentResourceLinking(t){return typeof t=="string"||!t||t&&t.service&&(t.service=m(t.service||[]).map(n=>this.traverseService(n,t))),t}traverseContentResource(t,n){return t.type==="Choice"&&(t.items=t.items.map(i=>this.traverseContentResource(i,t))),h(t)?this.traverseSpecificResource(t,"ContentResource"):this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(t)),{parent:n},this.traversals.contentResource)}traverseSpecificResource(t,n,i){let r=t.source;return typeof t.source=="string"&&(r={id:t.source,type:n||"unknown"}),this.traverseType({...t,source:n==="Canvas"||r.type==="Canvas"?this.traverseType(r,{parent:i},this.traversals.canvas):n==="ContentResource"?this.traverseContentResource(r,{parent:i}):this.traverseUnknown(r,{parent:i,typeHint:n})},{parent:i},this.traversals.specificResource)}traverseRangeRanges(t){return t.items&&(t.items=t.items.map(n=>typeof n=="string"?this.traverseCanvas({id:n,type:"Canvas"},t):h(n)?this.traverseSpecificResource(n,"Canvas",t):n.type==="Manifest"?this.traverseManifest(n,t):this.traverseRange(n,t))),t}traverseRange(t,n){return this.traverseType(this._traverseRange(t),{parent:n},this.traversals.range)}traverseAgent(t,n){return this.traverseType(this.traverseDescriptive(this.traverseLinking(t)),{parent:n},this.traversals.agent)}traverseType(t,n,i){return i.reduce((r,a)=>{let o=a(r,n);return typeof o>"u"&&!this.options.allowUndefinedReturn?r:o},t)}traverseService(t,n){let i=Object.assign({},t);return i&&i.service&&(i.service=m(i.service).map(r=>this.traverseService(r))),this.traverseType(i,{parent:n},this.traversals.service)}traverseUnknown(t,{parent:n,typeHint:i}={}){let r=he(t,i);switch(r){case"Collection":return this.traverseCollection(t,n);case"Manifest":return this.traverseManifest(t,n);case"Canvas":return this.traverseCanvas(t,n);case"AnnotationPage":return this.traverseAnnotationPage(t,n);case"Annotation":return this.traverseAnnotation(t,n);case"ContentResource":return this.traverseContentResource(t,n);case"Range":return this.traverseRange(t,n);case"Service":return this.traverseService(t,n);case"Agent":return this.traverseAgent(t,n);default:throw new Error(`Unknown or unsupported resource type of ${r}`)}}};var me=["sc:Collection","sc:Manifest","sc:Canvas","sc:AnnotationList","oa:Annotation","sc:Range","sc:Layer","sc:Sequence","oa:Choice","Service","ContentResource"];function pt(e){if(typeof e>"u"||e===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(e))throw new Error("Array is not a valid entity");if(typeof e!="object")throw new Error(`${typeof e} is not a valid entity`);if(typeof e["@type"]=="string"){let t=me.indexOf(e["@type"]);if(t!==-1)return me[t]}if(e.profile)return"Service";if(e.format||e["@type"])return"ContentResource";throw new Error("Resource type is not known")}var K=class e{constructor(t,n={}){A(this,"traversals");A(this,"options");this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...t},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...n}}static all(t){return new e({collection:[t],manifest:[t],canvas:[t],annotationList:[t],sequence:[t],annotation:[t],contentResource:[t],choice:[t],range:[t],service:[t],layer:[t]})}traverseCollection(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(t))),this.traversals.collection)}traverseCollectionItems(t){if(this.options.mergeMemberProperties){let n=[...(t.manifests||[]).map(a=>typeof a=="string"?{"@id":a,"@type":"sc:Manifest"}:a),...(t.collections||[]).map(a=>typeof a=="string"?{"@id":a,"@type":"sc:Collection"}:a),...t.members||[]],i=[],r=n.filter(a=>i.includes(a["@id"])?!1:(i.push(a["@id"]),!0));delete t.collections,delete t.manifests,t.members=r}return t.manifests&&(t.manifests=t.manifests.map(n=>this.traverseManifest(typeof n=="string"?{"@id":n,"@type":"sc:Manifest"}:n))),t.collections&&(t.collections=t.collections.map(n=>this.traverseCollection(typeof n=="string"?{"@id":n,"@type":"sc:Collection"}:n))),t.members&&(t.members=t.members.map(n=>typeof n=="string"?n:n["@type"]==="sc:Collection"?this.traverseCollection(n):n["@type"]==="sc:Manifest"?this.traverseManifest(n):this.traverseUnknown(n))),t}traverseManifest(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(t))),this.traversals.manifest)}traverseManifestItems(t){return t.sequences&&(t.sequences=t.sequences.map(n=>this.traverseSequence(n))),t.structures&&(t.structures=t.structures.map(n=>this.traverseRange(n))),t}traverseSequence(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(t))),this.traversals.sequence)}traverseSequenceItems(t){return t.canvases&&(t.canvases=t.canvases.map(n=>this.traverseCanvas(n))),t}traverseCanvas(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(t))),this.traversals.canvas)}traverseCanvasItems(t){return t.images&&(t.images=t.images.map(n=>this.traverseAnnotation(n))),t.otherContent&&(t.otherContent=t.otherContent.map(n=>this.traverseAnnotationList(n))),t}traverseRange(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(t))),this.traversals.range)}traverseRangeItems(t){if(this.options.mergeMemberProperties){let n=[...(t.ranges||[]).map(i=>typeof i=="string"?{"@id":i,"@type":"sc:Range"}:i),...(t.canvases||[]).map(i=>typeof i=="string"?{"@id":i,"@type":"sc:Canvas"}:i),...t.members||[]];delete t.ranges,delete t.canvases,t.members=n.length?n.map(i=>this.traverseUnknown(i)):void 0}return t}traverseAnnotationList(t){let n=typeof t=="string"?{"@id":t,"@type":"sc:AnnotationList"}:t;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(n)),this.traversals.annotationList)}traverseAnnotationListItems(t){return t.resources&&(t.resources=t.resources.map(n=>this.traverseAnnotation(n))),t}traverseAnnotation(t){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(t))),this.traversals.annotation)}traverseAnnotationItems(t){return t.resource&&(Array.isArray(t.resource)?t.resource=t.resource.map(n=>this.traverseContentResource(n)):t.resource=this.traverseContentResource(t.resource)),t.on,t}traverseLayer(t){return this.traverseType(this.traverseLinking(this.traverseLayerItems(t)),this.traversals.layer)}traverseLayerItems(t){return t.otherContent&&(t.otherContent=t.otherContent.map(n=>this.traverseAnnotationList(n))),t}traverseChoice(t){return this.traverseType(this.traverseChoiceItems(t),this.traversals.choice)}traverseChoiceItems(t){return t.default&&t.default!=="rdf:nil"&&(t.default=this.traverseContentResource(t.default)),t.item&&t.item!=="rdf:nil"&&(t.item=t.item.map(n=>this.traverseContentResource(n))),t}traverseService(t){return this.traverseType(this.traverseLinking(t),this.traversals.service)}traverseContentResource(t){return t["@type"]==="oa:Choice"?this.traverseChoice(t):this.traverseType(this.traverseDescriptive(this.traverseLinking(t)),this.traversals.contentResource)}traverseUnknown(t){if(!t["@type"]||typeof t=="string")return t;switch(pt(t)){case"sc:Collection":return this.traverseCollection(t);case"sc:Manifest":return this.traverseManifest(t);case"sc:Canvas":return this.traverseCanvas(t);case"sc:Sequence":return this.traverseSequence(t);case"sc:Range":return this.traverseRange(t);case"oa:Annotation":return this.traverseAnnotation(t);case"sc:AnnotationList":return this.traverseAnnotationList(t);case"sc:Layer":return this.traverseLayer(t);case"Service":return this.traverseService(t);case"oa:Choice":return this.traverseChoice(t);case"ContentResource":return this.traverseContentResource(t)}return t.profile?this.traverseService(t):t}traverseImageResource(t){let n=Array.isArray(t),i=Array.isArray(t)?t:[t],r=[];for(let a of i)typeof a=="string"?r.push(this.traverseContentResource({"@id":a,"@type":"dctypes:Image"})):r.push(this.traverseContentResource(a));return!n&&!this.options.convertPropsToArray?r[0]:r}traverseDescriptive(t){return t.thumbnail&&(t.thumbnail=this.traverseImageResource(t.thumbnail)),t.logo&&(t.logo=this.traverseImageResource(t.logo)),t}traverseOneOrMoreServices(t){let n=Array.isArray(t),i=Array.isArray(t)?t:[t],r=[];for(let a of i)r.push(this.traverseService(a));return!n&&!this.options.convertPropsToArray?r[0]:r}traverseLinking(t){return t.related&&(t.related=this.traverseOneOrManyType(t.related,this.traversals.contentResource)),t.rendering&&(t.rendering=this.traverseOneOrManyType(t.rendering,this.traversals.contentResource)),t.service&&(t.service=this.traverseOneOrMoreServices(t.service)),t.seeAlso&&(t.seeAlso=this.traverseOneOrManyType(t.seeAlso,this.traversals.contentResource)),t.within&&(typeof t.within=="string"||(t.within=this.traverseOneOrManyType(t.within,this.traversals.contentResource))),t.startCanvas&&(typeof t.startCanvas=="string"?t.startCanvas=this.traverseType({"@id":t.startCanvas,"@type":"sc:Canvas"},this.traversals.canvas):t.startCanvas&&this.traverseType(t.startCanvas,this.traversals.canvas)),t.contentLayer&&(typeof t.contentLayer=="string"?t.contentLayer=this.traverseLayer({"@id":t.contentLayer,"@type":"sc:Layer"}):t.contentLayer=this.traverseLayer(t.contentLayer)),t}traverseOneOrManyType(t,n){if(!Array.isArray(t))if(this.options.convertPropsToArray)t=[t];else return this.traverseType(t,n);return t.map(i=>this.traverseType(i,n))}traverseType(t,n){return n.reduce((i,r)=>{let a=r(i);return typeof a>"u"&&!this.options.allowUndefinedReturn?i:a},t)}};var ft="http://library.stanford.edu/iiif/image-api/compliance.html#level1",ut="http://library.stanford.edu/iiif/image-api/compliance.html#level2";var dt="http://library.stanford.edu/iiif/image-api/conformance.html#level1",vt="http://library.stanford.edu/iiif/image-api/conformance.html#level2";var yt="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",ht="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2";var mt="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",gt="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2";var At="http://iiif.io/api/image/1/level1.json",Ct="http://iiif.io/api/image/1/profiles/level1.json",Rt="http://iiif.io/api/image/1/level2.json",It="http://iiif.io/api/image/1/profiles/level2.json";var Pt="http://iiif.io/api/image/2/level1.json",St="http://iiif.io/api/image/2/profiles/level1.json",Tt="http://iiif.io/api/image/2/level2.json",_t="http://iiif.io/api/image/2/profiles/level2.json";var xt="level1",Et="level2";var Lt="http://iiif.io/api/image/2/level1",Mt="http://iiif.io/api/image/2/level2",ge=[Lt,Mt,ft,ut,dt,vt,yt,ht,mt,gt,At,Ct,Rt,It,Pt,St,Tt,_t,xt,Et];function g(e){for(let t in e)(typeof e[t]>"u"||e[t]===null)&&delete e[t];return e}var bt="http://library.stanford.edu/iiif/image-api/compliance.html#level0",Ae="http://library.stanford.edu/iiif/image-api/compliance.html#level1",Ce="http://library.stanford.edu/iiif/image-api/compliance.html#level2",Nt="http://library.stanford.edu/iiif/image-api/conformance.html#level0",Re="http://library.stanford.edu/iiif/image-api/conformance.html#level1",Ie="http://library.stanford.edu/iiif/image-api/conformance.html#level2",Ot="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",Pe="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",Se="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",wt="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",Te="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",_e="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",Ft="http://iiif.io/api/image/1/level0.json",zt="http://iiif.io/api/image/1/profiles/level0.json",xe="http://iiif.io/api/image/1/level1.json",Ee="http://iiif.io/api/image/1/profiles/level1.json",Le="http://iiif.io/api/image/1/level2.json",Me="http://iiif.io/api/image/1/profiles/level2.json",Dt="http://iiif.io/api/image/2/level0.json",kt="http://iiif.io/api/image/2/profiles/level0.json",be="http://iiif.io/api/image/2/level1.json",Ne="http://iiif.io/api/image/2/profiles/level1.json",Oe="http://iiif.io/api/image/2/level2.json",we="http://iiif.io/api/image/2/profiles/level2.json",jt="level0",Fe="level1",ze="level2",Gt="http://iiif.io/api/image/2/level0",De="http://iiif.io/api/image/2/level1",ke="http://iiif.io/api/image/2/level2",le=[ke,Ce,Ie,Se,_e,Le,Me,Oe,we,ze],ti=[...le,De,Ae,Re,Pe,Te,xe,Ee,be,Ne,Fe],Ut=[Gt,De,ke,bt,Ae,Ce,Nt,Re,Ie,Ot,Pe,Se,wt,Te,_e,Ft,zt,xe,Ee,Le,Me,Dt,kt,be,Ne,Oe,we,jt,Fe,ze],je=Ut;var pe={attributionLabel:"Attribution",lang:"none",providerId:"http://example.org/provider",providerName:""};function qt(e){if(typeof e=="string")return[e];if(!e)return[];let t=Array.isArray(e)?e:[e],n=[];for(let i of t){if(typeof i=="string"){n.push(i);continue}n.push({"@language":i["@language"]||i.language,"@value":i["@value"]||i.value})}return n}function O(e,t="none"){if(!e)return{none:[""]};let n=qt(e),i={};for(let r of n){if(typeof r=="string"){i[t]=i[t]?i[t]:[],i[t].push(r||"");continue}if(!r["@language"]){i[t]=i[t]?i[t]:[],i[t].push(r["@value"]||"");continue}let a=r["@language"];i[a]=i[a]?i[a]:[],i[a].push(r["@value"]||"")}return Object.keys(i).length===0?{none:[""]}:i}function Ve(e){if(Array.isArray(e))return Ve(e.find(t=>typeof t=="string"));if(le.indexOf(e)!==-1)return"level2";if(ge.indexOf(e)!==-1)return"level1";if(je.indexOf(e)!==-1)return"level0";if(typeof e=="string")return e}function Vt(e){let t=Array.isArray(e)?e:[e];for(let n of t)switch(n){case"http://iiif.io/api/image/2/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":return"ImageService2";case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return"ImageService1";case"http://iiif.io/api/annex/openannotation/context.json":return"ImageApiSelector"}}function Wt(e){switch(e){case"http://iiif.io/api/image/2/level0.json":case"http://iiif.io/api/image/2/level1.json":case"http://iiif.io/api/image/2/level2.json":return"ImageService2";case"http://iiif.io/api/auth/1/kiosk":case"http://iiif.io/api/auth/1/login":case"http://iiif.io/api/auth/1/clickthrough":case"http://iiif.io/api/auth/1/external":case"http://iiif.io/api/auth/0/kiosk":case"http://iiif.io/api/auth/0/login":case"http://iiif.io/api/auth/0/clickthrough":case"http://iiif.io/api/auth/0/external":return"AuthCookieService1";case"http://iiif.io/api/auth/1/token":case"http://iiif.io/api/auth/0/token":return"AuthTokenService1";case"http://iiif.io/api/auth/1/logout":case"http://iiif.io/api/auth/0/logout":return"AuthLogoutService1";case"http://iiif.io/api/search/1/search":case"http://iiif.io/api/search/0/search":return"SearchService1";case"http://iiif.io/api/search/1/autocomplete":case"http://iiif.io/api/search/0/autocomplete":return"AutoCompleteService1"}}function Ge(e){for(let t of["sc","oa","dcterms","dctypes","iiif"])if(e.startsWith(`${t}:`))return e.slice(t.length+1);return e}var Bt=["Collection","Manifest","Annotation","AnnotationPage","Range","Service"];function ue(e){let t=e["@id"]||e.id,n=e["@type"]||e.type,i=e.profile||void 0,r=e["@context"]||void 0;if(i){let a=Wt(i);if(a)return a}if(r){let a=Vt(r);if(a)return a}if(n){if(Array.isArray(n)){if(n.indexOf("oa:CssStylesheet")!==-1)return"CssStylesheet";if(n.indexOf("cnt:ContentAsText")!==-1)return"TextualBody";n=n[0]}for(let a of["sc","oa","dcterms","dctypes","iiif"])if(n.startsWith(`${a}:`)){n=n.slice(a.length+1);break}switch(n){case"Layer":return"AnnotationCollection";case"AnnotationList":return"AnnotationPage";case"cnt:ContentAsText":return"TextualBody"}}if(n&&Bt.indexOf(n)!==-1)return n;if(e.format){if(e.format.startsWith("image/"))return"Image";if(e.format.startsWith("text/")||e.format==="application/pdf")return"Text";if(e.format.startsWith("application/"))return"Dataset"}return t&&(t.endsWith(".jpg")||t.endsWith(".png")||t.endsWith(".jpeg"))?"Image":n||"unknown"}var $t=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function Ht(e){let t=e.match($t);return t?t[0]:e}function Kt(e,t="Rights/License",n="none"){let i=null,r=[],a=Array.isArray(e)?e:[e];for(let o of a){let l=o?Ht(o):void 0;if(l&&(l.indexOf("creativecommons.org")!==-1||l.indexOf("rightsstatements.org")!==-1)){l.startsWith("https://")?i=`http://${l.slice(8)}`:i=l;continue}l&&r.push({label:{[n]:[t]},value:{[n]:[l]}})}return[i,r]}var Jt=["http://iiif.io/api/presentation/2/context.json","http://iiif.io/api/image/2/context.json","http://iiif.io/api/image/1/context.json","http://library.stanford.edu/iiif/image-api/1.1/context.json","http://iiif.io/api/search/1/context.json","http://iiif.io/api/search/0/context.json","http://iiif.io/api/auth/1/context.json","http://iiif.io/api/auth/0/context.json","http://iiif.io/api/annex/openannotation/context.json"];function Qt(e){if(e){let t=Array.isArray(e)?e:[e],n=[];for(let i of t)i==="http://iiif.io/api/presentation/2/context.json"&&n.push("http://iiif.io/api/presentation/3/context.json"),Jt.indexOf(i)===-1&&n.push(i);if(t.length)return n.length===1?n[0]:n}}function Xt(e){return e?e.map(t=>({label:O(t.label),value:O(t.value)})):[]}var Ue=0;function We(e,t){let n=encodeURI(e.id||e["@id"]||"").trim();return n&&t?`${n}/${t}`:n||(Ue++,`http://example.org/${e["@type"]}${t?`/${t}`:""}/${Ue}`)}function I(e){let t=[...e.behavior||[]];e.viewingHint&&t.push(e.viewingHint);let n;return Array.isArray(e.motivation)?n=e.motivation.map(Ge):e.motivation&&(n=Ge(e.motivation)),{"@context":e["@context"]?Qt(e["@context"]):void 0,id:(e["@id"]||We(e)).trim(),type:ue(e),behavior:t.length?t:void 0,height:e.height?e.height:void 0,width:e.width?e.width:void 0,motivation:n,viewingDirection:e.viewingDirection,profile:e.profile,format:e.format?e.format:void 0,duration:void 0,timeMode:void 0}}function P(e){let[t,n]=Kt(e.license),i=[...e.metadata?Xt(e.metadata):[],...n];return{rights:t,metadata:i.length?i:void 0,label:e.label?O(e.label):void 0,requiredStatement:e.attribution?{label:O(pe.attributionLabel),value:O(e.attribution)}:void 0,navDate:e.navDate,summary:e.description?O(e.description):void 0,thumbnail:Yt(e.thumbnail)}}function Yt(e){return e&&(Array.isArray(e)?e:[e]).map(n=>typeof n=="string"?{id:n,type:"Image"}:(n.type==="unknown"&&(n.type="Image"),n))}function Zt(e){if(!e.within)return;let t=Array.isArray(e.within)?e.within:[e.within],n=[];for(let i of t)if(typeof i=="string"){if(i)switch(e["@type"]){case"sc:Manifest":n.push({id:i,type:"Collection"});break}}else i["@id"]&&n.push({id:i["@id"],type:ue(i)});return n.length?n:void 0}function T(e){let t=e.related?Array.isArray(e.related)?e.related:[e.related]:[],n=e.contentLayer;return{provider:e.logo||t.length?[{id:pe.providerId,type:"Agent",homepage:t.length?[t[0]]:void 0,logo:e.logo?Array.isArray(e.logo)?e.logo:[e.logo]:void 0,label:O(pe.providerName)}]:void 0,partOf:Zt(e),rendering:e.rendering,seeAlso:e.seeAlso,start:e.startCanvas,service:e.service?m(e.service):void 0,supplementary:n?[n]:void 0}}function en(e){return{chars:e.chars,format:e.format?e.format:void 0,language:e.language}}function ce(e,t){return e?typeof e=="string"?{id:e,type:t}:typeof e?.["@id"]=="string"?{id:e["@id"],type:t}:typeof e.id=="string"?{id:e.id,type:t}:null:null}function tn(e){let t={};if(e.first){let n=ce(e.first,"Collection");n&&(t.first=n)}if((e.total||e.total===0)&&(t.total=e.total),e.prev){let n=ce(e.prev,"Collection");n&&(t.prev=n)}if(e.next){let n=ce(e.next,"Collection");n&&(t.next=n)}return t}function nn(e){let t=[];for(let n of e){let i={...n};i.items&&i.items.length===0&&delete i.items,t.push(i)}return t}function rn(e){return g({...I(e),...P(e),...T(e),...tn(e),items:nn(e.members)})}function an(e){let t=[],n=[],i,r;for(let o of e.sequences||[])o.canvases.length&&t.push(...o.canvases),o.behavior&&n.push(...o.behavior),o.viewingDirection&&(r=o.viewingDirection),o.startCanvas&&(i=o.startCanvas);let a=I(e);return n.length&&(a.behavior?a.behavior.push(...n):a.behavior=n),g({...a,...P(e),...T(e),viewingDirection:r,start:i,items:t,structures:sn(e.structures)})}function sn(e){if(!e)return e;let t=new Map;for(let i of e)t.set(i.id,i);let n=[];for(let i of e)if(i.items){let r=i.items.map(a=>typeof a=="string"?(n.push(a),t.get(a)||a):a&&a.id?(n.push(a.id),t.get(a.id)||a):a);i.items=r}return e.filter(i=>n.indexOf(i.id)===-1)}function on(e){return g({...I(e),...P(e),...T(e),annotations:e.otherContent&&e.otherContent.length?e.otherContent:void 0,items:e.images&&e.images.length?[{id:We(e,"annotation-page"),type:"AnnotationPage",items:e.images}]:void 0})}function ln(e){return g({...I(e),...P(e),...T(e),items:e.resources&&e.resources.length?e.resources:void 0})}function cn(e){return!e.canvases||e.canvases.length===0?{canvases:[],behavior:[]}:{canvases:e.canvases,behavior:e.viewingHint?[e.viewingHint]:[],viewingDirection:e.viewingDirection,startCanvas:e.startCanvas}}function pn(e){function t(n){if(Array.isArray(n)){if(n.length>1)return{type:"List",items:n.map(t)};n=n[0]}if(typeof n=="string")return encodeURI(n).trim();if("@type"in n){let i;if(typeof n.full=="string")i=n.full;else if(n.full["@type"]==="dctypes:Image")i={id:n.full["@id"],type:"Image"};else if(n.full["@type"]==="sc:Canvas")i={id:n.full["@id"],type:"Canvas"};else throw new Error(`Unsupported source type on annotation: ${n.full["@type"]}`);return{type:"SpecificResource",source:i,selector:fe(n.selector)}}else return encodeURI(n["@id"]).trim()}return g({...I(e),...P(e),...T(e),target:t(e.on),body:Array.isArray(e.resource)?e.resource.map(qe):qe(e.resource)})}function qe(e){return e.type==="Choice"?e:Be(e)}function Be(e){let t=e;return g({...I(t),...P(t),...T(t),...en(t)})}function fn(e){let t=[];return e.default&&e.default!=="rdf:nil"&&t.push(e.default),e.item&&e.item!=="rdf:nil"&&t.push(...e.item),g({...I(e),...P(e),items:t})}function un(e){return g({...I(e),...P(e),...T(e),items:e.members})}function dn(e){let{"@id":t,"@type":n,"@context":i,profile:r,...a}=e,o={};return t&&(o["@id"]=t),o["@type"]=ue(e),o["@type"]==="unknown"&&(i&&i.length&&(o["@context"]=i),o["@type"]="Service"),r&&(o.profile=Ve(r)),g({...o,...a})}function vn(e){return g({...I(e),...P(e),...T(e)})}var yn=new K({collection:[rn],manifest:[an],canvas:[on],annotationList:[ln],sequence:[cn],annotation:[pn],contentResource:[Be],choice:[fn],range:[un],service:[dn],layer:[vn]});function $e(e){return e&&e["@context"]&&(e["@context"]==="http://iiif.io/api/presentation/2/context.json"||e["@context"].indexOf("http://iiif.io/api/presentation/2/context.json")!==-1||e["@context"]==="http://www.shared-canvas.org/ns/context.json")||e["@context"]==="http://iiif.io/api/image/2/context.json"||e["@id"]&&e["@type"]==="sc:Collection"||e["@id"]&&e["@type"]==="sc:Manifest"?(e["@context"]||(e["@context"]="http://iiif.io/api/presentation/2/context.json"),yn.traverseUnknown(e)):e}function fe(e){if((Array.isArray(e["@type"])&&e["@type"].includes("oa:SvgSelector")||e["@type"]=="oa:SvgSelector")&&("chars"in e||"value"in e))return{type:"SvgSelector",value:"chars"in e?e.chars:e.value};if(e["@type"]==="oa:FragmentSelector")return{type:"FragmentSelector",value:e.value};if(e["@type"]==="oa:Choice")return[fe(e.default),...(Array.isArray(e.item)?e.item:[e.item]).map(fe)];if(e["@type"]=="iiif:ImageApiSelector")return{type:"ImageApiSelector",region:"region"in e?e.region:void 0,rotation:"rotation"in e?e.rotation:void 0};throw new Error(`Unsupported selector type: ${e["@type"]}`)}function J(e,t={}){if(Array.isArray(e))return J(e[0]);if(typeof e=="string"){let[n,i]=e.split("#");return i?{type:"SpecificResource",source:{id:n,type:t.typeHint||"Unknown"},selector:{type:"FragmentSelector",value:i}}:{type:"SpecificResource",source:{id:n,type:t.typeMap&&t.typeMap[n]||t.typeHint||"Unknown"}}}if(e.type==="Choice"||e.type==="List"||e.type==="Composite"||e.type==="Independents")return J(e.items[0]);if(!e.type&&"source"in e&&(e.type="SpecificResource"),e.type==="SpecificResource")return e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:"Manifest"}]),e.selector?{type:"SpecificResource",source:e.source,selector:e.selector}:{type:"SpecificResource",source:e.source};if(e.id){e.type==="Canvas"&&e.partOf&&typeof e.partOf=="string"&&(e.partOf=[{id:e.partOf,type:"Manifest"}]);let[n,i]=e.id.split("#");return i?{type:"SpecificResource",source:{...e,id:n},selector:{type:"FragmentSelector",value:i}}:{type:"SpecificResource",source:{...e,id:n}}}return{type:"SpecificResource",source:e}}var hn={Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}};function He(){return{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}}}function Ke(e,t){if(typeof e=="string")return{id:e,type:t};if(!e.id)throw new Error(`Invalid resource does not have an ID (${JSON.stringify(e)}, ${t})`);return e}function mn(e,t){return(n,i)=>{let r=e[n]?e[n]:{};return(a,o)=>{let l=Ke(a,i||n);return l&&l.id&&n?(r[l.id]=r[l.id]?Y(r[l.id],l,{parent:o.parent,isTopLevel:t.id===l.id}):Y({id:l.id,type:l.type},l,{parent:o.parent,isTopLevel:t.id===l.id}),{id:l.id,type:n==="ContentResource"?n:l.type}):l}}}function X(e,t,n){if(!t)return e;if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Cannot merge array with non-array");let i=[...e];for(let r of t)if(r["@id"]&&!r.id&&(r.id=r["@id"]),r["@type"]&&!r.type&&(r.type=r["@type"]),r!=null)if(Array.isArray(r))i.push(r);else if(typeof r=="object"&&r.id&&r.type){let a=i.findIndex(o=>o.id===r.id&&o.type===r.type);a>=0&&(i[a]=X(i[a],r))}else e.indexOf(r)===-1&&i.push(r);return i}else if(typeof e=="object"){if(Array.isArray(t)||typeof t!="object")throw new Error("Cannot merge object with non-object");let i={...e},r=[],a=[],o=Object.keys(e).filter(c=>c!==u&&c!=="id"&&c!=="type"),l={},M={};for(let[c,f]of Object.entries(t)){if(c===u||c==="id"||c==="type")continue;let v=i[c];v===f?a.push(c):v===s||!v?(r.push(c),i[c]=f):(v&&f&&(l[c]=v,M[c]=f),i[c]=X(v,f),i[c]===l[c]&&(a.push(c),delete l[c]))}if(n&&(n.parent&&n.parent.id||n.isTopLevel)){let c=[],f={};if(n.parent?f[R]=n.parent.id:n.isTopLevel&&(f[R]=e.id),i[u]&&i[u].length){let v=!(i[u]||[]).find(C=>C["@explicit"]),b=r.length>0||a.length!==o.length;if(v&&b)for(let C of i[u]){let d={...C},Z=Object.keys(l);if(d){d["@explicit"]=!0;for(let j of o)j!==u&&(d[j]=N);for(let j of Z)d[j]=l[j]}c.push(d)}else c.push(...i[u]);if(b){let C=Object.keys(M);f["@explicit"]=!0;for(let d of r)f[d]=N;for(let d of a)f[d]=N;for(let d of C)f[d]=M[d]}}f.id=i.id,f.type=i.type,c.push(f),i[u]=c}return i}else if(e)return e;return t}function Y(e,t,n){if(typeof e=="string")return e;if(t.id!==e.id||t.type!==e.type){if(t.type==="ImageService3")return t;if(e.type==="ImageService3")return e;throw new Error(`Can only merge entities with identical identifiers and type! ${t.type}(${t.id}) => ${e.type}(${e.id})`)}return X({...e},t,n)}function gn(e){return(t,n)=>i=>{let{id:r,type:a}=Ke(i,n||t);if(typeof r>"u")throw new Error("Found invalid entity without an ID.");return t==="ContentResource"||t==="Service"?e[r]=t:e[r]=a,i}}function An(e){let t=Object.assign({},e);if(t["@id"]&&(t.id=t["@id"]),t["@type"]&&(t.type=t["@type"]),t.service){let n=[];t.service=Array.isArray(t.service)?t.service:[t.service];for(let i of t.service)n.push({id:i["@id"]||i.id,type:i["@type"]||i.type});t.service=n}return Object.assign({},se,t)}function Cn(e){return t=>{e.Service=e.Service?e.Service:{};let n=t.id||t["@id"],i=An(t);return i&&i.id&&(e.Service[i.id]?e.Service[n]=Y(e.Service[n],i):e.Service[n]=i),t}}function Rn(e){let t=JSON.stringify(e),n=5381,i=t.length;for(;i;)n=n*33^t.charCodeAt(--i);let a=(n>>>0).toString(16);return a.length%2?"0"+a:a}function de(e){return t=>typeof t=="string"?{id:t,type:e}:t.id?t.type?t:{type:e,...t}:{id:`vault://${Rn(t)}`,type:e,...t}}function k(e){return t=>({...e,...t})}function V(e){return Array.isArray(e)?e:[e]}function In(e){return e.body&&(e.body=V(e.body)),e.seeAlso&&(e.seeAlso=V(e.seeAlso)),e.audience&&(e.audience=V(e.audience)),e.accessibility&&(e.accessibility=V(e.accessibility)),e.motivation&&(e.motivation=V(e.motivation)),e}function Je(e,{typeHint:t,partOfTypeHint:n}={}){if(typeof e=="string"&&(e={id:e,type:t||"unknown"}),h(e))return typeof e.source=="string"&&(e.source={id:e.source,type:t||"unknown"}),e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:n||"Manifest"}]),e;let i;if((e.id||"").indexOf("#")!==-1){let[r,a]=(e.id||"").split("#");e.id=r,a&&(i={type:"FragmentSelector",value:a})}return{type:"SpecificResource",source:e,selector:i}}function Pn(e){let t=Object.assign({},e);return e&&e.items&&(t.items=e.items.map(n=>typeof n=="string"||n.type==="Canvas"?Je(n):n)),t}function Sn(e){let t=Object.assign({},e);return t.start?(t.start=Je(t.start,{typeHint:"Canvas"}),t):e}function Tn(e){let t=Object.assign({},e);return t.target?(t.target=J(t.target,{typeHint:"Canvas"}),t):e}function Qe(e){return e}function Q(e){return typeof e.items>"u"&&(e[S]=!0),e}function _n(e){let t=$e(e),n=He(),i={},r=mn(n,t),a=gn(i),l=new q({collection:[Q,k(ne),a("Collection"),r("Collection")],manifest:[Q,k(ie),Sn,a("Manifest"),r("Manifest")],canvas:[k(te),a("Canvas"),r("Canvas")],annotationPage:[Q,de("AnnotationPage"),k(ee),a("AnnotationPage"),r("AnnotationPage")],annotation:[de("Annotation"),In,Tn,a("Annotation"),r("Annotation")],contentResource:[de("ContentResource"),a("ContentResource"),r("ContentResource")],range:[k(re),Pn,a("Range","Canvas"),r("Range","Canvas")],agent:[k(ae),a("Agent"),r("Agent")],specificResource:[Qe],service:[Cn(n)]}).traverseUnknown(t);return{entities:n,resource:l,mapping:i}}function Xe(e){let t={};for(let[n,i]of e){if(n===G&&i!==y)return i;i!==y&&typeof i<"u"&&i!==null&&(t[n]=i)}return t}function xn(e,t,n){if(!t.type||!t.id)throw new Error("Unknown entity");if(!n[t.type])throw new Error(`Serializer not found for ${t.type}`);function i(r,a,o=0){let l=n[r.type];if(!l)return y;if(o>20)throw new Error("Circular reference: "+r.id+" "+r.type);let[M,c]=H(e,r.type?r:r.id,a)||(r.id&&r.type?r:null);if(!M)return y;let f=l(M,e,{parent:a,isTopLevel:t.id===r.id,fullResource:c}),v=f.next();for(;!v.done;){let b=v.value,C=y;if(b)if(Array.isArray(b)){let d=[];for(let Z of b)d.push(i(Z,r,o+1));C=d}else C=i(b,r,o+1);v=f.next(C)}return v.value===y?y:Xe(v.value)}return i(t)}function _(e,{allowSourceString:t=!0,allowString:n=!1,allowedStringType:i}={}){let r=a=>{if(t&&a&&a.source&&typeof a.source!="string"){let o=Object.keys(a.source);if(a.source.id&&a.source.type&&o.length===2)return{...a,source:a.source.id}}return a};if(e){if(e.source&&e.source.partOf)return r(e);let a=Object.keys(e);if(a.length===2&&e.type&&e.source||a.length===3&&e.type&&e.source&&a.indexOf("selector")!==-1&&!e.selector)return n&&(!i||i===e.source.type)?e.source.id:e.source.type==="ContentResource"?{type:"SpecificResource",source:e.source.id}:e.source;if(e.selector&&!Array.isArray(e.selector)&&typeof e.selector!="string"&&e.selector.type==="FragmentSelector"){let o=`${e.source.id}#${e.selector.value}`;return n?o:{id:o,type:e.source.type}}}return r(e)}function z(e){if(!e)return;let t=Object.keys(e);if(t.length!==0){if(t.length===1){let n=t[0];if(!n)return"";let i=(e[n]||[]).join("");return n==="@none"||n==="none"||n==="en"?i:{"@language":n,"@value":i}}return t.map(n=>({"@language":n,"@value":(e[n]||[]).join("")}))}}function Ye(e){return Array.isArray(e)?e.map(t=>Ye(t)):typeof e=="string"?e:e.type&&e.type==="Canvas"?e.id:e}function x(e,t=!1){if(e)return e.length>1&&!t?e:e[0]||void 0}function En(e){if(e){if(typeof e=="string")return{"@id":e};if("@id"in e){let t={...e};return delete t["@type"],t}return{"@context":"http://iiif.io/api/image/2/context.json","@id":e.id,profile:`http://iiif.io/api/image/2/profiles/${e.profile}.json`}}}function w(e,t){return[["@id",e.id],["@type",t],["format",e.format],["height",e.height],["width",e.width],["viewingDirection",e.viewingDirection!=="left-to-right"?e.viewingDirection:void 0],["license",e.license?e.license:void 0]]}function*F(e){let t=e.provider?yield e.provider[0]:void 0;return[["label",z(e.label)],["metadata",e.metadata&&e.metadata.length?e.metadata.map(n=>({label:z(n.label)||"",value:z(n.value)||""})):void 0],["description",z(e.summary)],["thumbnail",x(yield e.thumbnail)],["navDate",e.navDate],["logo",t?x(t.logo):void 0],["homepage",t?t.homepage:void 0],["attribution",e.requiredStatement?z(e.requiredStatement.value):void 0]]}function*W(e){let t=e.start&&e.start.type&&e.start.type==="SpecificResource"?_(e.start):e.start;return[["seeAlso",x(yield e.seeAlso)],["service",x((e.service||[]).map(En))],["rendering",x(yield e.rendering)],["startCanvas",t?t.id:void 0]]}function Ln(e){return e.type==="SpecificResource"}function Mn(e){return e&&e.type==="FragmentSelector"}function bn(e){if(e&&Ln(e)){let t=e.id,n=e.selector?Array.isArray(e.selector)?e.selector[0]:e.selector:void 0;return Mn(n)&&(t+="#"+n.value),t}return e?.id}var Nn={Manifest:function*(e,t,{isTopLevel:n}){return[...n?[["@context","http://iiif.io/api/presentation/2/context.json"]]:[],...w(e,"sc:Manifest"),...yield*F(e),...yield*W(e),["sequences",[{"@id":`${e.id}/sequence0`,"@type":"sc:Sequence",canvases:yield e.items}]],["structures",yield e.structures]]},Canvas:function*(e){let n=(yield e.items)[0];return[...w(e,"sc:Canvas"),...yield*F(e),...yield*W(e),["images",n?[n.resources]:void 0],["annotations",e.annotations&&e.annotations.length?x(yield e.annotations):void 0]]},AnnotationPage:function*(e){return[...w(e,"sc:AnnotationList"),...yield*F(e),["resources",e.items&&e.items.length?x(yield e.items):void 0]]},Annotation:function*(e){return[["@id",e.id],["@type","oa:Annotation"],["motivation","sc:painting"],["on",Ye(e.target)],["resource",x(yield e.body,!0)]]},ContentResource:function*(e){switch(e.type){case"Image":return[...w(e,"dctypes:Image"),...yield*F(e),...yield*W(e)];case"Text":case"Dataset":default:return[...w(e,void 0),...yield*F(e)]}},AnnotationCollection:function*(e){return[["@id",e.id],["@type","sc:Layer"],["label",z(e.label)]]},Collection:function*(e){return[...w(e,"sc:Collection"),...yield*F(e),...yield*W(e),["members",yield*e.items]]},Range:function*(e){let t=[],n=[];if(e.items)for(let i of e.items){let r=i.type==="SpecificResource"?i.source:i;if(r){let a=yield r;t.push({"@id":bn(i),"@type":r.type,label:a?a.label:void 0,within:e.id}),r.type==="Canvas"&&n.push(r.id)}}return[...w(e,"sc:Range"),...yield*F(e),...yield*W(e),["canvases",n.length===t.length?n:void 0],["members",n.length!==t.length?t:void 0]]}};function D(e){return[["id",e.id?.startsWith("vault://")?void 0:e.id],["type",e.type],["format",e.format],["profile",e.profile],["height",e.height||void 0],["width",e.width||void 0],["duration",e.duration||void 0],["viewingDirection",e.viewingDirection!=="left-to-right"?e.viewingDirection:void 0],["behavior",e.behavior&&e.behavior.length?e.behavior:void 0],["timeMode",e.timeMode],["motivation",Array.isArray(e.motivation)?e.motivation[0]:e.motivation],[u,y]]}function p(e){if(e===y||!e||e.length===0)return;let t=e.filter(n=>n!==y);if(t.length!==0)return t}function tt(e){if(e&&e.type&&e.type==="ImageService2"){let{id:t,type:n,profile:i,...r}=e,a=typeof i=="string"?i:Array.isArray(i)?i.find(o=>typeof o=="string"):"";return{"@id":t,"@type":n,profile:a?a.startsWith("http")?a:`http://iiif.io/api/image/2/${a}.json`:"http://iiif.io/api/image/2/level0.json",...r}}return e}function Ze(e){if(Array.isArray(e)||(e=e?[e]:[]),!(!e||e.length===0))return e.map(tt)}function*E(e){return[["label",e.label],["metadata",p(e.metadata)],["summary",e.summary],["requiredStatement",e.requiredStatement],["rights",Array.isArray(e.rights)?e.rights[0]||void 0:e.rights||void 0],["navDate",e.navDate],["language",e.language],["thumbnail",p(yield e.thumbnail)],["placeholderCanvas",yield e.placeholderCanvas],["accompanyingCanvas",yield e.accompanyingCanvas],["provider",p(yield e.provider)]]}function*L(e,t){let n=[];for(let i of e.partOf||[])i.type==="Manifest"&&t.type==="Manifest"||n.push(yield i);return[["seeAlso",p(yield e.seeAlso)],["service",p(Ze(e.service))],["services",p(Ze(e.services))],["rendering",p(yield e.rendering)],["supplementary",p(yield e.supplementary)],["homepage",p(yield e.homepage)],["logo",p(yield e.logo)],["partOf",p(n)],["start",e.start?_(e.start):e.start]]}var On={Manifest:function*(e,t,{isTopLevel:n}){if(!n)return[...D(e),...yield*E(e),["navPlace",e.navPlace]];let i="http://iiif.io/api/presentation/3/context.json";return(e.navPlace||et(e))&&(i=["http://iiif.io/api/presentation/3/context.json","http://iiif.io/api/extension/navplace/context.json"]),[["@context",e["@context"]?e["@context"]:i],...D(e),...yield*E(e),...yield*L(e),["items",yield e.items],["structures",p(yield e.structures)],["annotations",p(yield e.annotations)],["navPlace",e.navPlace]]},Canvas:function*(e,t,{parent:n}){return n&&n.type!=="Manifest"&&n.type!=="Canvas"?[["id",e.id]]:[...D(e),...yield*E(e),...yield*L(e,n),["items",yield e.items],["annotations",p(yield e.annotations)],["navPlace",e.navPlace]]},Agent:function*(e){return[["id",e.id],["type","Agent"],["label",e.label],...yield*L(e)]},AnnotationPage:function*(e){let t=Object.entries(e).map(([i,r])=>[i,Array.isArray(r)?p(r):r]).filter(([i,r])=>i!=="items"&&i!=="id"&&i!==u&&i!==R&&i!==S),n=yield e.items;return[["id",e.id?.startsWith("vault://")?void 0:e.id],...t,...yield*L(e),["items",n.length||e[S]===!1?n:y]]},Service:function*(e){return[[G,tt(e)]]},Annotation:function*(e){let t=Object.entries(e).map(([i,r])=>i==="motivation"?[i,Array.isArray(r)?r[0]:r]:i==="target"?[i,_(r,{allowString:!0,allowSourceString:!0,allowedStringType:"Canvas"})]:[i,Array.isArray(r)?p(r):r]).filter(([i])=>i!=="body"&&i!==u&&i!==S),n;if(Array.isArray(e.body)){let i=[];for(let r of e.body)if(r&&h(r)){let a={...r};r.source.type!=="Canvas"?a.source=yield r.source:a.source=r.source,i.push(_(a,{allowSourceString:!0}))}else i.push(yield r);n=i}else e.body&&h(e.body)?(n={...e.body},n.source=yield e.body.source):n=yield e.body;return[...t,...yield*E(e),...yield*L(e),["body",n.length===1?n[0]:n]]},ContentResource:function*(e){return wn([...D(e),...yield*E(e),...yield*L(e),["annotations",p(yield e.annotations)],["items",p(yield e.items)]],e)},AnnotationCollection:function*(e){return[["id",e.id],["type","AnnotationCollection"],["label",e.label]]},Collection:function*(e,t,{isTopLevel:n}){if(n){let i="http://iiif.io/api/presentation/3/context.json";return(e.navPlace||et(e))&&(i=["http://iiif.io/api/extension/navplace/context.json","http://iiif.io/api/presentation/3/context.json"]),[["@context",i],...D(e),...yield*E(e),...yield*L(e),["items",p(yield e.items)],["navPlace",e.navPlace]]}return[...D(e),...yield*E(e),["navPlace",e.navPlace]]},Range:function*(e){let t=[];for(let n of e.items)n.type==="Range"?t.push(yield n):n&&n.type==="SpecificResource"?t.push(_(n)):t.push(n);return[...D(e),...yield*E(e),...yield*L(e),["items",t],["annotations",p(yield e.annotations)],["navPlace",e.navPlace]]}};function wn(e,t){let n=Object.keys(t),i=e.map(([r])=>r);for(let r of n)r===u||r===S||i.indexOf(r)===-1&&typeof t[r]<"u"&&e.push([r,t[r]]);return e}function et(e){if(!e.items||!Array.isArray(e.items))return!1;for(let t of e.items)if(t.navPlace)return!0;return!1}
