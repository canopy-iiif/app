"use strict";var y=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var x=(a,e,n)=>e in a?y(a,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[e]=n;var L=(a,e)=>{for(var n in e)y(a,n,{get:e[n],enumerable:!0})},k=(a,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of S(e))!M.call(a,r)&&r!==n&&y(a,r,{get:()=>e[r],enumerable:!(t=I(e,r))||t.enumerable});return a};var D=a=>k(y({},"__esModule",{value:!0}),a);var v=(a,e,n)=>(x(a,typeof e!="symbol"?e+"":e,n),n);var G={};L(G,{presentation3StrictUpgrade:()=>B});module.exports=D(G);function c(a){return typeof a=="string"?!1:a&&!a.type&&"source"in a?(a.type="SpecificResource",!0):!!a&&a.type==="SpecificResource"}function o(a){return Array.isArray(a)?a:a?[a]:[]}function f(...a){return e=>a.reduce((n,t)=>t(n),e)}var R=["Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent"];function $(a,e){if(typeof a>"u"||a===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(a))throw new Error("Array is not a valid entity");if(typeof a!="object"){if(e)return e;throw new Error(`${typeof a} is not a valid entity`)}if(typeof a.type=="string"){let n=R.indexOf(a.type);if(n!==-1)return R[n]}if(a.profile)return"Service";throw new Error("Resource type is not known")}var d=class a{constructor(e,n={}){v(this,"traversals");v(this,"options");v(this,"_traverseManifest",f(this.traverseManifestItems.bind(this),this.traverseNavPlace.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseManifestStructures.bind(this),this.traverseInlineAnnotationPages.bind(this)));v(this,"_traverseCanvas",f(this.traverseCanvasItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseInlineAnnotationPages.bind(this)));v(this,"_traverseAnnotationPage",f(this.traverseAnnotationPageItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this)));v(this,"_traverseRange",f(this.traverseRangeRanges.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this)));this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],specificResource:[],geoJson:[],...e},this.options={allowUndefinedReturn:!1,...n}}static all(e){return new a({collection:[e],manifest:[e],canvas:[e],annotationCollection:[e],annotationPage:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],geoJson:[e],specificResource:[e],agent:[e]})}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=o(e.thumbnail).map(n=>this.traverseType(n,{parent:e},this.traversals.contentResource))),e.provider&&(e.provider=e.provider.map(n=>this.traverseAgent(n,e))),e}traverseLinking(e){return e.seeAlso&&(e.seeAlso=o(e.seeAlso).map(n=>this.traverseType(n,{parent:e},this.traversals.contentResource))),e.service&&(e.service=o(e.service).map(n=>this.traverseService(n))),e.services&&(e.services=o(e.services).map(n=>this.traverseService(n,e))),e.logo&&(e.logo=o(e.logo).map(n=>this.traverseType(n,{parent:e},this.traversals.contentResource))),e.homepage&&(e.homepage=o(e.homepage).map(n=>this.traverseType(n,{parent:e},this.traversals.contentResource))),e.partOf&&(e.partOf=e.partOf.map(n=>typeof n=="string"||!n.type?this.traverseType(n,{parent:e},this.traversals.contentResource):n.type==="Canvas"?this.traverseType(n,{parent:e},this.traversals.canvas):n.type==="AnnotationCollection"?this.traverseType(n,{parent:e},this.traversals.annotationCollection):n.type==="Collection"?this.traverseType(n,{parent:e},this.traversals.collection):this.traverseType(n,{parent:e},this.traversals.contentResource))),e.start&&(c(e.start)?e.start=this.traverseSpecificResource(e.start,"Canvas",e):e.start=this.traverseType(e.start,{parent:e},this.traversals.canvas)),e.rendering&&(e.rendering=e.rendering.map(n=>this.traverseType(n,{parent:e},this.traversals.contentResource))),e.supplementary&&(e.supplementary=e.supplementary.map(n=>this.traverseType(n,{parent:e},this.traversals.contentResource))),e}traverseCollectionItems(e){return e.items&&e.items.map(n=>n.type==="Collection"?this.traverseCollection(n):this.traverseManifest(n)),e}traverseCollection(e,n){return this.traverseType(this.traverseDescriptive(this.traverseNavPlace(this.traverseInlineAnnotationPages(this.traverseLinking(this.traverseLinkedCanvases(this.traverseCollectionItems(e)))))),{parent:n},this.traversals.collection)}traverseGeoJson(e,n){return this.traverseType(e,{parent:n},this.traversals.geoJson)}traverseNavPlace(e){return e.navPlace&&(e.navPlace=this.traverseGeoJson(e.navPlace,e)),e}traverseManifestItems(e){return e.items&&(e.items=e.items.map(n=>this.traverseCanvas(n))),e}traverseManifestStructures(e){return e.structures&&(e.structures=e.structures.map(n=>this.traverseRange(n))),e}traverseManifest(e,n){return this.traverseType(this._traverseManifest(e),{parent:n},this.traversals.manifest)}traverseCanvasItems(e){return e.items=(e.items||[]).map(n=>this.traverseAnnotationPage(n,e)),e}traverseInlineAnnotationPages(e){return typeof e=="string"||!e||e.annotations&&(e.annotations=e.annotations.map(n=>this.traverseAnnotationPage(n,e))),e}traverseCanvas(e,n){return this.traverseType(this._traverseCanvas(e),{parent:n},this.traversals.canvas)}traverseAnnotationPageItems(e){return e.items&&(e.items=e.items.map(n=>this.traverseAnnotation(n,e))),e}traverseAnnotationPage(e,n){return this.traverseType(this._traverseAnnotationPage(e),{parent:n},this.traversals.annotationPage)}traverseAnnotationBody(e){return Array.isArray(e.body)?e.body=e.body.map(n=>this.traverseContentResource(n,e)):e.body&&(e.body=this.traverseContentResource(e.body,e)),e}traverseLinkedCanvases(e){return e.placeholderCanvas&&(e.placeholderCanvas=this.traverseCanvas(e.placeholderCanvas)),e.accompanyingCanvas&&(e.accompanyingCanvas=this.traverseCanvas(e.accompanyingCanvas)),e}traverseAnnotation(e,n){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(this.traverseDescriptive(e))),{parent:n},this.traversals.annotation)}traverseContentResourceLinking(e){return typeof e=="string"||!e||e&&e.service&&(e.service=o(e.service||[]).map(n=>this.traverseService(n,e))),e}traverseContentResource(e,n){return e.type==="Choice"&&(e.items=e.items.map(t=>this.traverseContentResource(t,e))),c(e)?this.traverseSpecificResource(e,"ContentResource"):this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(e)),{parent:n},this.traversals.contentResource)}traverseSpecificResource(e,n,t){let r=e.source;return typeof e.source=="string"&&(r={id:e.source,type:n||"unknown"}),this.traverseType({...e,source:n==="Canvas"||r.type==="Canvas"?this.traverseType(r,{parent:t},this.traversals.canvas):n==="ContentResource"?this.traverseContentResource(r,{parent:t}):this.traverseUnknown(r,{parent:t,typeHint:n})},{parent:t},this.traversals.specificResource)}traverseRangeRanges(e){return e.items&&(e.items=e.items.map(n=>typeof n=="string"?this.traverseCanvas({id:n,type:"Canvas"},e):c(n)?this.traverseSpecificResource(n,"Canvas",e):n.type==="Manifest"?this.traverseManifest(n,e):this.traverseRange(n,e))),e}traverseRange(e,n){return this.traverseType(this._traverseRange(e),{parent:n},this.traversals.range)}traverseAgent(e,n){return this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),{parent:n},this.traversals.agent)}traverseType(e,n,t){return t.reduce((r,l)=>{let h=l(r,n);return typeof h>"u"&&!this.options.allowUndefinedReturn?r:h},e)}traverseService(e,n){let t=Object.assign({},e);return t&&t.service&&(t.service=o(t.service).map(r=>this.traverseService(r))),this.traverseType(t,{parent:n},this.traversals.service)}traverseUnknown(e,{parent:n,typeHint:t}={}){let r=$(e,t);switch(r){case"Collection":return this.traverseCollection(e,n);case"Manifest":return this.traverseManifest(e,n);case"Canvas":return this.traverseCanvas(e,n);case"AnnotationPage":return this.traverseAnnotationPage(e,n);case"Annotation":return this.traverseAnnotation(e,n);case"ContentResource":return this.traverseContentResource(e,n);case"Range":return this.traverseRange(e,n);case"Service":return this.traverseService(e,n);case"Agent":return this.traverseAgent(e,n);default:throw new Error(`Unknown or unsupported resource type of ${r}`)}}};function P(a){for(let e in a)(typeof a[e]>"u"||a[e]===null)&&delete a[e];return a}var U=/-?([1-9]\d{3,}|0\d{3})-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])T(([01]\d|2[0-3]):[0-5]\d:[0-5]\d(\.\d+)?|(24:00:00(\.0+)?))(Z|(\+|-)((0\d|1[0-3]):[0-5]\d|14:00))?/,i={warnings:[]};function E(a,e=i){return a.behavior&&(a.behavior=s(a.behavior,"behavior",e)),a.width=C(a.width,"width",!1,e),a.height=C(a.height,"height",!1,e),a.duration=C(a.duration,"duration",!0,e),a.format&&typeof a.format!="string"&&(e.warnings.push('"format" should be a single string'),Array.isArray(a.format)&&typeof a.format[0]=="string"?a.format=a.format[0]:a.format=void 0),a}function m(a,e,n=i){return a&&Array.isArray(a)?a.filter(t=>{let r=e(t);return r&&n.warnings.indexOf(r)===-1&&n.warnings.push(r),!r}):a}function s(a,e,n=i){return Array.isArray(a)?a:(n.warnings.push(`"${e}" should be Array of values`),[a])}function A(a,e,n=i){return Array.isArray(a)?(n.warnings.push(`"${e}" should only contain a single value`),a.length===0?void 0:a[0]):a}function C(a,e,n=!1,t=i){if(!(typeof a>"u")){if(typeof a=="string"){let r=n?parseFloat(a):Math.abs(Number(a));if(Number.isNaN(r)||r<=0){t.warnings.push(`"${e}" expected value to be a ${n?"Number":"Integer"}, instead found an invalid value`);return}return t.warnings.push(`"${e}" expected value to be a ${n?"Number":"Integer"}, instead found a string`),r}return!n&&a%1!==0?(t.warnings.push(`"${e}" expected value to be a Integer, instead found a Float`),Math.floor(a)):a}}function g(a,e,n=i){if(Array.isArray(a))return typeof a[0]=="string"?(n.warnings.push(`"${e}" should be a language map instead found a string`),{none:a}):(n.warnings.push(`"${e}" should be a language map instead found an unknown value`),{none:[""]});if(typeof a=="string")return n.warnings.push(`"${e}" should be a language map instead found a string`),{none:[a]};let t=Object.keys(a),r={},l=!1;for(let h of t){let p=a[h],u=[];if(typeof p=="string")l=!0,n.warnings.push(`"${e}" values inside a language map should be an Array of strings, found a string`),u.push(p);else if(Array.isArray(p))for(let T of p)typeof T!="string"?(l=!0,n.warnings.push(`"${e}" values inside a language map should be an Array of strings, found an unknown value`)):u.push(T);else l=!0,n.warnings.push(`"${e}" values inside a language map should be an Array of strings, found an unknown value`);u.length>0&&(r[h]=u)}return l?Object.keys(r).length===0?{none:[""]}:r:a}function b(a,e,n="",t=i){return typeof a=="string"?(t.warnings.push(`"${e}" should be a {label, value} set of Language maps`),{label:{none:[n]},value:{none:[a]}}):((!a.label&&a.value||a.label&&!a.value)&&t.warnings.push(`"${e}" should have both a label and a value`),a.label?a.label=g(a.label,`${e}.label`,t):a.label={none:[n]},a.value?a.value=g(a.value,`${e}.value`,t):a.value={none:[""]},a)}function W(a,e=i){if(a.label&&(a.label=g(a.label,"label",e)),a.summary&&(a.summary=g(a.summary,"summary",e)),a.requiredStatement&&(a.requiredStatement=b(a.requiredStatement,"requiredStatement","Required statement",e)),a.metadata)if(Array.isArray(a.metadata))for(let n=0;n<a.metadata.length;n++)a.metadata[n]=b(a.metadata[n],`metadata.${n}`,"",e);else e.warnings.push('"metadata" should be an array of {label, value} Language maps'),a.metadata=[];if(a.rights&&(Array.isArray(a.rights)&&(e.warnings.push('"rights" should only contain a single string'),a.rights=typeof a.rights[0]=="string"?a.rights[0]:""),typeof a.rights=="string"&&!a.rights.startsWith("http")?e.warnings.push('"rights" should be a valid URI'):typeof a.rights=="string"&&a.rights.startsWith("https")&&(e.warnings.push('"rights" is an informative property and should contain the http variation of the rights statement'),a.rights=`http${a.rights.slice(5)}`)),a.navDate){let n=typeof a.navDate=="string"?a.navDate.trim():void 0;n!==a.navDate&&(e.warnings.push('"navDate" should not contain extra whitespace'),a.navDate=n),(typeof a.navDate!="string"||!a.navDate.match(U))&&(e.warnings.push('"navDate" should be a valid XSD dateTime literal'),a.navDate=void 0)}return a.language&&(a.language=s(a.language,"language",e),a.language=m(a.language,n=>typeof n=="string"?void 0:`'"language" expected array of strings`,e)),a.accompanyingCanvas&&(a.accompanyingCanvas=A(a.accompanyingCanvas,"accompanyingCanvas",e),a.accompanyingCanvas?.type!=="Canvas"&&e.warnings.push('"accompanyingCanvas" should be a Canvas')),a.placeholderCanvas&&(a.placeholderCanvas=A(a.placeholderCanvas,"placeholderCanvas",e),a.placeholderCanvas?.type!=="Canvas"&&e.warnings.push('"placeholderCanvas" should be a Canvas')),a.thumbnail&&(a.thumbnail=s(a.thumbnail,"thumbnail",e)),a}var w={Manifest:"Canvas",Canvas:"AnnotationPage",AnnotationPage:"Annotation"};function N(a,e=i){let n=a.type;switch(n){case"Canvas":case"AnnotationPage":case"Manifest":a&&a.items&&(a.items=m(a.items,t=>t.type===w[n]?void 0:`"${a.type}.items" should contain only type ${w[n]}, found ${t.type}`,e))}return a}function _(a,e=i){return a.logo&&(a.logo=s(a.logo,"logo",e)),a.service&&(a.service=s(a.service,"service",e)),a.seeAlso&&(a.seeAlso=s(a.seeAlso,"seeAlso",e)),a.rendering&&(a.rendering=s(a.rendering,"rendering",e)),a.partOf&&(a.partOf=s(a.partOf,"partOf",e)),a.homepage&&(a.homepage=s(a.homepage,"homepage",e)),a.services&&(a.services=s(a.services,"services",e)),a.supplementary&&(a.supplementary=s(a.supplementary,"supplementary",e)),a.start&&(a.start=A(a.start,"start",e)),a}function q(a){return e=>{if(e)return typeof e=="string"||Array.isArray(e)?e:P({...e,...E(e,a),...W(e,a),..._(e,a),...N(e,a)})}}function B(a,e=i){return d.all(q(e)).traverseManifest(a)}
