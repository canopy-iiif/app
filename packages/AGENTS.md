Workspace Agent Notes
=====================

Helpers
-------

- Keep all repository helper scripts in `packages/helpers/` (not in a root `scripts/` folder).
- Common tasks:
  - Release guard: `node packages/helpers/guard-publish.js`
  - Build verification: `node packages/helpers/verify-build.js`

Publishing
----------

- Only `@canopy-iiif/lib` and `@canopy-iiif/ui` are publishable. All other workspace packages remain `private: true`.
- `@canopy-iiif/ui` builds its `dist/` via `prepublishOnly`.

IIIF Build
----------

- Enable by adding `content/works/_layout.mdx`. This layout receives `props.manifest` (normalized to IIIF Presentation 3 if possible).
- Configure the collection URI in `canopy.yml` (`collection.uri`) or via `CANOPY_COLLECTION_URI`.
- Outputs work pages at `site/works/<slug>.html`.
- Tune performance with `iiif.chunkSize` and `iiif.concurrency` (or env `CANOPY_CHUNK_SIZE`, `CANOPY_FETCH_CONCURRENCY`).

IIIF Cache
----------

- `.cache/iiif/index.json`: tracks `byId` (ids→slugs/parents) and `collection` meta.
- `.cache/iiif/manifests/{slug}.json`: cached normalized Manifests.
- Changing the collection URI resets the cache; delete `.cache/iiif/` to force refetch.

Assets and Live Reload
----------------------

- Files in the repository `assets/` directory are mirrored into `site/` (subpaths preserved) by the build.
- The dev server watches `assets/` and copies only changed files to `site/` without a full rebuild; a live reload is triggered.

Dev Quick Notes
---------------

- `npm run dev` serves `http://localhost:3000` with live reload.
- MDX edits rebuild the site; asset edits sync directly to `site/`.

UI Workspace (@canopy-iiif/ui)
------------------------------

- Build outputs (generated by `scripts/build-ui.mjs`):
  - `dist/index.js` (browser ESM, platform: neutral)
    - Externals: `react`, `react-dom`, `react-dom/client`, `react-masonry-css`, `flexsearch`, `@samvera/clover-iiif/*`.
    - Goal: avoid pre-bundling browser deps that the lib’s runtime (in `@canopy-iiif/lib`) will bundle with React/FlexSearch shims.
  - `dist/server.js` (Node ESM, SSR-safe subset)
    - Only exports MDX placeholders and SSR-compatible components.
    - Do not import browser-only deps here.
- Exposed entries:
  - `@canopy-iiif/ui` → browser bundle (used by client runtimes)
  - `@canopy-iiif/ui/server` → SSR-only entry (used by `@canopy-iiif/lib/mdx.js`)
- Components:
  - `Grid` (Masonry) depends on `react-masonry-css`; keep it external in the UI build.
  - `SearchResults` accepts `layout`: `'grid' | 'list'` (default `'grid'`) and uses `Grid` when `'grid'`.
- Adding new browser-only deps:
  - Add them to UI externals and ensure the consumer runtime (usually in `@canopy-iiif/lib`) shims or bundles them appropriately.
- Troubleshooting (UI):
  - Dynamic require errors in browser usually mean a CJS dep was inlined; verify externals list matches the consumer runtime shims.

Lib Workspace (@canopy-iiif/lib)
---------------------------------

- MDX SSR (`packages/lib/mdx.js`):
  - Imports UI via `@canopy-iiif/ui/server` to avoid pulling browser-only code during SSR.
- Search runtime bundling (`packages/lib/search.js`):
  - Injects browser globals: `site/scripts/react-globals.js` for React/ReactDOM and a FlexSearch globals shim.
  - Esbuild plugin shims:
    - `react` → reads from `window.React`
    - `react-dom/client` → reads from `window.ReactDOMClient`
    - `react-dom` → reads from `window.ReactDOM`
    - `flexsearch` → reads from `window.FlexSearch`
  - When UI adds browser deps (e.g., `react-masonry-css`), leave them in the UI externals so the search runtime can bundle/transform them with the React shims.
- Troubleshooting (Lib):
  - If search breaks with “Dynamic require of 'react'”, verify the UI bundle kept that dep external and the runtime shims are active.

Helpers Workspace (@canopy-iiif/helpers)
----------------------------------------

- Keep repo maintenance scripts here; do not add top-level `scripts/`.
- No direct coupling with UI/Lib bundles; but release guards should ensure only `@canopy-iiif/lib` and `@canopy-iiif/ui` are publishable.

UI Build and SSR
----------------

- UI exposes two build outputs:
  - `dist/index.js` (browser ESM, `platform: neutral`) — externals: `react`, `react-dom`, `react-dom/client`, `react-masonry-css`, `flexsearch`, `@samvera/clover-iiif/*`.
  - `dist/server.js` (Node ESM) — SSR‑safe exports only; used by `packages/lib/mdx.js` via `@canopy-iiif/ui/server`.
- The search runtime bundles client UI and provides shims mapping React/FlexSearch to browser globals; keep those libs external in the UI bundle.

Search Results Layout
---------------------

- `SearchResults` supports `layout` prop: `'grid' | 'list'` (default `'grid'`).
- The `'grid'` path uses a Masonry `Grid` built on `react-masonry-css` with scoped CSS.
